# Spotify Playlist Importer - Upgrade Todolist

Based on `docs/project_upgrade_plan.md` (Version 1.2)

## I. 高优先级（基础与效率）

### 1.1 API 速率限制处理与并发执行框架 (同步API + 线程)
- [x] **1.1.1: 搭建同步API调用与并发执行环境:**
    - [x] 使用 `spotipy` (同步库) 进行核心Spotify API调用。
    - [x] 将 `spotipy` 的同步调用通过 `asyncio.to_thread` 在主异步框架的线程池中执行，以实现并发处理歌曲搜索等IO密集型任务。
- [x] **1.1.2: 实现并发控制:**
    - [x] 添加可配置的并发数量限制（例如，通过配置文件设置，用于控制并发线程数）。
    - [x] 使用 `asyncio.Semaphore` （或类似机制）管理提交到线程池的任务数量，确保并发行为符合预期且可控。
    - [x] (可选高级) 研究线程池大小与 `Semaphore` 限制的协同工作，优化资源利用。
- [x] **1.1.3: 实现健壮的API速率限制处理逻辑 (例如429错误):**
    - [x] 深入理解并验证 `spotipy` 库内置的错误处理和重试机制。
    - [x] 在API调用封装层面（如 `search_song_on_spotify_sync_wrapped`）添加更精细的异常捕获，以应对 `spotipy` 未处理或处理不充分的特定API错误。
    - [x] 如 `spotipy` 的默认处理不足，考虑实现基于 `Retry-After` 响应头（如果可获取）的等待或指数退避策略的封装层。
    - [x] 设置可配置的最大重试次数（如果实现自定义重试）。
- [x] **1.1.4: API模块的单元与集成测试:**
    - [x] Mock `spotipy` 的响应，测试错误处理、重试逻辑（自定义或 `spotipy` 内置的）。
    - [x] 在模拟负载下测试并发控制和线程池表现。

### 1.2 增强日志系统
- [x] **1.2.1: 集成 Python `logging` 模块:**
    - [x] 确保项目中所有错误/状态报告均通过 `logging` 调用。
- [x] **1.2.2: 配置日志级别:**
    - [x] 允许通过配置文件或环境变量设置日志级别 (DEBUG, INFO, WARNING, ERROR)。
- [x] **1.2.3: 实现详细的调试日志:**
    - [x] 为匹配过程的关键步骤（包括预处理、各阶段相似度计算、得分、决策过程）添加DEBUG级别的详细日志。

## II. 中高优先级（核心准确率提升）

### 2.1 文本预处理与归一化模块
- [x] **2.1.1: 实现核心的文本归一化功能:**
    - [x] 实现中文简繁体统一功能 (例如，使用 `opencc-python-reimplemented`)。
    - [x] 实现英文字母大小写统一功能 (转为小写)。
    - [x] 实现全角/半角字符统一功能。
- [x] **2.1.2: 实现特定模式的去除/替换:**
    - [x] 设计并实现一个可配置的机制（例如，通过JSON/YAML文件）来管理用于去除/替换的正则表达式或关键词列表 (例如 `(live)`, `[remastered]`, `(feat. ...)` 等)。
    - [x] 实现应用这些模式的逻辑。
- [x] **2.1.3: 实现空白字符与分隔符的标准化:**
    - [x] 标准化处理连字符 `-`、斜杠 `/`、与号 `&` 等。
    - [x] 去除首尾多余空格，并将连续的多个内部空格压缩为单个。
- [x] **2.1.4: 创建统一的归一化工具函数:**
    - [x] 将所有归一化步骤封装成一个易于调用的函数/类。
- [x] **2.1.5: 归一化模块的单元测试:**
    - [x] 针对每个归一化步骤编写测试用例，覆盖不同类型的输入。
    - [x] 测试统一的归一化工具函数/类。

### 2.2 歌曲搜索查询增强与候选获取
- [x] **2.2.1: 优化Spotify API搜索参数:**
    - [x] 将 `sp.search()` 调用中的 `limit` 参数设为动态可配置（例如通过配置文件，建议默认值为5-10），以获取足够的候选歌曲进行后续匹配。
- [x] **2.2.2: 增强查询构建逻辑:**
    - [x] 确保构建搜索查询字符串的逻辑能有效利用标准化后的歌曲标题和所有艺术家信息。
    - [x] (可选) 尝试不同的查询组合策略（例如，仅标题，标题+主艺术家，标题+所有艺术家）以应对不同情况。

### 2.3 实现第一阶段的基于字符串相似度的匹配 (核心匹配逻辑 - 忽略括号信息)
- [x] **2.3.1: 集成字符串相似度库:**
    - [x] 将选定的库 (如 `thefuzz` (fuzzywuzzy的新版) 或 `textdistance`) 添加到项目依赖中。
- [x] **2.3.2: 实现标题相似度评分:**
    - [x] 对每个从Spotify API获取的候选歌曲，计算其归一化标题与输入歌曲归一化标题之间的相似度得分（例如使用 `thefuzz.ratio` 或 `token_set_ratio`）。
- [x] **2.3.3: 实现艺术家列表相似度评分:**
    - [x] 对每个候选歌曲，计算其归一化艺术家列表与输入歌曲归一化艺术家列表之间的相似度得分（可考虑Jaccard相似度、平均最佳匹配、或将艺术家列表视为一个整体字符串用 `thefuzz` 计算）。
- [x] **2.3.4: 实现第一阶段的加权评分与候选筛选:**
    - [x] 使用可配置的权重 (`Wt_title`, `Wa_artist`) 组合标题相似度得分和艺术家相似度得分，得到第一阶段的综合评分 `score_stage1`。
    - [x] 应用可配置的初步阈值 (`T_stage1_min_score`) 过滤掉明显不相关的候选歌曲。
    - [x] (可选) 从通过初步阈值的候选中，选出得分最高的Top K个（例如K=3-5）进入下一阶段精细匹配，或全部进入。
- [x] **2.3.5: 第一阶段匹配的日志记录:**
    - [x] 添加DEBUG级别的日志，详细记录：输入歌曲信息、每个候选歌曲的原始信息、归一化后的文本、标题相似度、艺术家相似度、以及计算出的 `score_stage1`。

## III. 中优先级（精细化准确率）

### 3.1 实现第二阶段的匹配逻辑 (处理括号内特殊信息)
- [x] **3.1.1: 提取与归一化括号内/特殊标记信息:**
    - [x] 实现从用户输入歌曲名和候选歌曲名中提取括号内文本（如 `(Live)`, `(Remix)`, `(Acoustic)`）以及其他特殊标记（如 `feat.`, `- Version`）的逻辑。
    - [x] 对提取出的这些信息应用适当的（可能更宽松或特定的）归一化规则。
- [x] **3.1.2: 实现括号内/特殊标记信息的比较与评分调整:**
    - [x] **关键词匹配**: 检查提取信息中是否包含特定关键词 (如 "live", "acoustic", "remix", "instrumental", "cover", "demo" 等)。
    - [x] **特征匹配**: 比较 `feat.` 后面的艺术家是否与输入或候选中的艺术家有重合。
    - [x] **相似度计算**: 如果括号内容较长，可计算用户输入与候选歌曲括号内信息的文本相似度。
    - [x] **调整分数**: 根据上述比较结果，对第一阶段的 `score_stage1` 进行加分或减分调整。例如：
        - 输入含 `(Live)`，候选也含 `(Live)` -> 加分
        - 输入无 `(Live)`，候选含 `(Live)` -> 减分（或可配置为不减分，视策略而定）
        - 匹配到 `feat.` 艺术家 -> 加分
- [x] **3.1.3: 计算最终匹配得分与选择最佳匹配:**
    - [x] 得到调整后的最终匹配得分 `final_score`。
    - [x] 应用可配置的最终阈值 (`T_final_min_score`) 于 `final_score`。
    - [x] 从所有通过最终阈值的候选中，选择 `final_score` 最高的作为最佳匹配。如果最高分相同，可有其他决胜规则（如更短的标题、发布日期等，此为高级优化）。
- [x] **3.1.4: 第二阶段匹配的日志记录:**
    - [x] 添加DEBUG级别的日志，记录提取的括号/特殊信息、比较过程、分数调整细节及计算出的 `final_score`。

## IV. 持续进行

- [x] **4.1 配置文件管理:**
    - [x] 确保所有可配置参数（并发数、API凭据相关路径、归一化模式、相似度算法选择、各阶段匹配的权重和阈值、`limit` 参数等）都从统一的配置文件 (如YAML, JSON) 或环境变量加载。
    - [x] 提供一个包含所有可配置项及其默认值的示例配置文件。
- [x] **4.2 单元测试与集成测试 (持续进行):**
    - [x] 为所有新增或修改的函数和模块（特别是匹配算法的各个阶段）编写全面的单元测试。
    - [x] 开发针对端到端匹配流程的集成测试，使用多样化的输入数据。
    - [x] (推荐) 创建并维护一个"黄金标准数据集"，包含已知匹配和不匹配的歌曲对，用于回归测试和准确率评估。
- [x] **4.3 性能分析与优化:**
    - [x] 在实现新的匹配算法后，使用大型输入列表对应用进行性能分析。
    - [x] 识别并解决文本处理、相似度计算或并发执行中的性能瓶颈。
- [x] **4.4 文档更新:**
    - [x] 更新 `README.md`，详细说明新的匹配逻辑、所有可配置参数及其作用、以及如何优化匹配效果。
    - [x] 为新增的内部模块和复杂匹配逻辑撰写必要的开发者文档或代码注释。

## V. 优化与重构 (可选)

### 5.1 共享Spotify客户端实例
- [x] **5.1.1: 设计并实现Spotify客户端实例的共享机制:**
    - [x] 目标：避免在每次API调用时都创建新的 `spotipy.Spotify` 实例，以减少不必要的认证开销和潜在的性能瓶颈。
    - [x] 考虑方案：
        - 方案A: 在应用启动时初始化一个全局的 `spotipy.Spotify` 实例，并在需要时传递或引用它。
        - 方案B: 使用一个单例模式或工厂模式来管理和提供 `spotipy.Spotify` 实例。
    - [x] 确保所选方案的线程安全性，特别是在并发环境中（如 `main_async.py` 中的异步调用）。
- [x] **5.1.2: 更新现有代码以使用共享实例:**
    - [x] 修改 `spotify_playlist_importer/spotify/client.py` 中的 `search_song_on_spotify` 函数，使其接收或获取共享的 `spotipy` 客户端实例。
    - [x] 修改 `spotify_playlist_importer/main_async.py` 中的 `search_song_on_spotify_sync_wrapped` 函数，确保它通过 `asyncio.to_thread` 传递或使用了共享的客户端实例。
    - [x] 检查并更新其他可能直接或间接创建 `spotipy.Spotify` 实例的地方。
- [x] **5.1.3: 测试共享实例的有效性和稳定性:**
    - [x] 验证API调用是否仍然按预期工作。
    - [x] 在并发场景下测试，确保没有因实例共享引入新的问题（如状态冲突、认证失败等）。
    - [x] (可选) 比较共享实例前后在大量API调用时的性能差异。

## VI. 进一步优化匹配逻辑与报告 (Stage 6)

### 6.1 文本预处理与归一化模块 (`text_normalizer.py`)
- [x] **6.1.1: 调整归一化策略以保留括号内容:**
    - [x] 修改 `normalize_text` (或创建新变体) 以在主归一化过程中保留原始括号及其内部文本。例如，`Song Title (feat. Artist X) [Live]` 归一化后应大致为 `song title (feat. artist x) [live]`。
    - [x] 新增一个辅助函数，能够将归一化后的字符串分割成"主要部分"和"括号内含/特殊标记部分"。例如，`song title (feat. artist x) [live]` -> `("song title", ["(feat. artist x)", "[live]"])`。

### 6.2 歌曲搜索查询 (`client.py`)
- [x] **6.2.1: 优化Spotify API搜索查询构建:**
    - [x] 查询时使用歌曲的"主要部分"（即不含括号内文本）。
    - [x] 查询时默认仅使用输入的前两位艺术家（如果艺术家信息可用）。如果只有一位艺术家，则使用该艺术家。如果没有艺术家信息，则仅按主要标题搜索。
- [x] **6.2.2: 配置搜索结果数量:**
    - [x] 将 `SPOTIFY_SEARCH_LIMIT` 的默认值调整为3（通过 `spotify_config.json` 或环境变量配置）。

### 6.3 候选歌曲处理 (`client.py`)
- [x] **6.3.1: 归一化API返回的候选歌曲:**
    - [x] 对从Spotify API获取的每个候选歌曲的标题和艺术家进行与6.1.1中用户输入相似的归一化处理，保留其括号内容。
    - [x] 对每个归一化后的候选歌曲，也使用6.1.1中的辅助函数分割出"主要部分"和"括号内含/特殊标记部分"。

### 6.4 核心匹配逻辑 (`StringMatcher` 或相关部分在 `client.py`)
- [x] **6.4.1: 实现主要信息匹配:**
    - [x] 比较用户输入歌曲的"主要标题"与候选歌曲的"主要标题"的相似度。
    - [x] 比较用户输入歌曲的 *完整* 艺术家列表与候选歌曲的 *完整* 艺术家列表的相似度。
    - [x] 使用可配置的权重 (`TITLE_WEIGHT`, `ARTIST_WEIGHT`) 组合这两个相似度得分，得到主要匹配分数。
- [x] **6.4.2: 实现括号内/特殊标记信息的补充匹配:**
    - [x] 比较用户输入歌曲的"括号内含/特殊标记部分"列表与候选歌曲的相应列表。
    - [x] 这部分的比较可以更灵活，例如：
        - 检查关键词完全匹配 (e.g., `(live)` vs `(live)`)。
        - 检查是否存在 `feat.` 艺术家的重合。
        - 计算括号内文本的整体相似度。
    - [x] 根据匹配程度，对此主要匹配分数进行调整（例如，通过一个较低权重的 `BRACKET_WEIGHT` 或 `KEYWORD_BONUS`）。
- [x] **6.4.3: 计算最终匹配得分:**
    - [x] 结合主要匹配分数和补充匹配的调整，得到最终匹配得分。

### 6.5 低置信度匹配处理 (`client.py`)
- [x] **6.5.1: 实现低置信度回退逻辑:**
    - [x] 如果所有候选歌曲的最终匹配得分均未达到配置的 `MATCH_THRESHOLD`。
    - [x] 选择其中得分最高的那个候选歌曲作为匹配结果。
    - [x] 在匹配结果对象 (e.g., `MatchedSong`) 中增加一个标志，表明这是一个"低置信度匹配"。

### 6.6 报告生成 (例如在 `main_async.py` 或处理报告的模块)
- [x] **6.6.1: 调整报告格式:**
    - [x] 原始输入歌曲信息显示为单行: `Original Input: <完整原始歌曲字符串>`
    - [x] 匹配到的歌曲信息显示为单行: `Matched Song: <匹配到的歌曲标题 - 艺术家1, 艺术家2 ...>`
    - [x] 如果未找到匹配，则显示: `Matched Song: Not Found`
    - [x] 如果是低置信度匹配，在匹配结果后附加标记: `Matched Song: <匹配到的歌曲标题 - 艺术家1, 艺术家2 ...> [Low Confidence]`
- [x] **6.6.2: 在报告中明确标识低置信度匹配。**

### 6.7 配置参数调整 (`config_manager.py`, `spotify_config.json`)
- [x] **6.7.1: 更新默认配置:**
    - [x] 将 `SPOTIFY_SEARCH_LIMIT` 的默认值设为3。
- [x] **6.7.2: 审阅并调整权重和阈值:**
    - [x] 根据新的两阶段匹配逻辑（主要信息匹配 + 括号信息补充），重新评估并调整 `TITLE_WEIGHT`, `ARTIST_WEIGHT`, `BRACKET_WEIGHT` (或新引入的类似权重), `KEYWORD_BONUS` 以及 `MATCH_THRESHOLD` 的默认值。
    - [x] 确保这些参数在 `spotify_config.json.example` 中有清晰的文档说明。

## VII. 最大化API调用成功率以确保获取候选歌曲 (Stage 7)

**核心前提**: 假定一个功能正常的Spotify API在接收到有效的歌曲查询时，总会返回候选歌曲。因此，本阶段专注于通过极度稳健的API交互策略，确保最大限度地从Spotify获取这些候选数据。

**目标**: 实施一套极其稳健的API请求和重试机制，以确保对每首输入歌曲的Spotify查询都能成功执行并获取候选列表（无论候选内容多少或质量高低），随后由现有的匹配逻辑从中选择一个最终匹配。

### 7.1 极端API调用稳健性与高级重试策略 (`spotify/async_client.py` 或同步客户端的等效部分)

-   [x] **7.1.1: 实现高度持久化且智能的API请求重试机制:**
    -   [x] 在核心API请求函数（例如，封装 `spotipy` 调用的 `make_request`）中：
        -   [x] **自动重试的触发条件**: 针对特定的、通常被认为是瞬态的HTTP错误码（例如，`429 Too Many Requests`，`500 Internal Server Error`，`502 Bad Gateway`，`503 Service Unavailable`）以及常见的网络级错误（如请求超时、DNS解析失败、连接错误）进行自动重试。
        -   [x] **重试参数配置**:
            -   实现可配置的**最大重试次数** (`API_MAX_RETRIES`)，默认值设为一个较高的数字（例如 **10到15次**），以应对持续的瞬时网络波动或API繁忙。
            -   实现可配置的**基础重试延迟时间** (`API_RETRY_BASE_DELAY_SECONDS`)，默认值适当增加（例如 **3到5秒**）。
            -   采用**带抖动的指数退避 (Exponential Backoff with Jitter)** 策略计算每次重试的延迟时间，例如：`delay = min(API_RETRY_MAX_DELAY_SECONDS, API_RETRY_BASE_DELAY_SECONDS * (2 ** retry_count) * (0.5 + random.uniform(0, 1)))`。
            -   实现可配置的**最大重试总时长** (`API_TOTAL_TIMEOUT_PER_CALL_SECONDS`)，确保即使一个单一API调用（包括其所有重试）也不会无限期阻塞整个处理流程。

-   [x] **7.1.2: 加强日志和监控:**
    -   [x] 详细记录每次重试的原因、尝试次数、等待时间等，以便诊断和解决持续失败的原因。
    -   [x] 记录单个请求（包括其所有重试）的总处理时间，帮助识别潜在的性能瓶颈。

-   [x] **7.1.3: 改进报告处理:**
    -   [x] 在匹配报告中单独标记API彻底失败（所有重试后仍然失败）的情况，与未找到匹配进行区分。
    -   [x] 提供详细的API错误上下文，帮助用户理解API交互失败的原因。

### 7.2 处理最终无法恢复的API调用失败 (在所有重试之后)

-   [x] **7.2.1: 定义并处理API调用在极致努力后仍失败的场景:**
    -   [x] 如果一个对Spotify的API调用（例如 `search` 请求），在执行了7.1.1中定义的所有重试尝试、并可能已达到 `API_TOTAL_TIMEOUT_PER_CALL_SECONDS` 后，**仍然未能成功获取HTTP 2xx响应**（即，API通信层面持续失败）：
        -   负责获取候选歌曲的函数（如 `search_song_on_spotify_async`）应明确地将此情况报告为**该特定查询的API交互彻底失败**。
        -   在这种情况下，该函数应返回 `None` (或一个清晰指示API失败的特殊错误对象/元组) 给调用者，表示未能从Spotify获取任何数据（包括空的候选列表）。
        -   **关键点**: 这被视为程序无法与Spotify就该查询成功通信，而不是Spotify对一个成功的查询返回了"无候选"。

### 7.3 对匹配流程和报告的影响

-   [x] **7.3.1: 确保匹配逻辑仅在获取到API候选时执行:**
    -   [x] 只有当 `search_song_on_spotify_async` (或其同步版本) 成功地从Spotify API返回了一个（可能为空，但通常按您的前提是非空的）候选歌曲列表时，才会调用 `BracketAwareMatcher`。
    -   [x] 如果API调用最终成功并返回了候选歌曲（哪怕只有一个，质量再差），`BracketAwareMatcher` 现有的逻辑会从中选择一个。`MatchedSong.is_low_confidence` 和 `final_score` 会如实反映其匹配质量。

-   [x] **7.3.2: 报告中清晰区分不同结果:**
    -   [x] **成功获取候选并匹配**:
        -   若 `MatchedSong.is_low_confidence` 为 `True` (即 `final_score < MATCH_THRESHOLD`):
            `Matched Song: <Spotify歌曲名> - <Spotify艺术家> [Low Confidence - Score: <final_score>]`
        -   否则 (高置信度匹配):
            `Matched Song: <Spotify歌曲名> - <Spotify艺术家>`
    -   [x] **API调用在所有重试后最终失败 (来自7.2.1)**:
        -   报告为: `Match Status: API Call Failed for Input "<原始输入行>" - Reason: <具体的API错误信息或超时说明>`
        -   在最终的统计摘要中，这类情况应归类为 "API交互失败" 或 "处理错误"，不计入"未找到歌曲"（因为我们未能成功查询）。

### 7.4 配置参数更新 (`spotify_config.json`, `utils/config_manager.py`)

-   [x] **7.4.1: 新增或调整配置文件中的API重试参数:**
    -   [x] `API_MAX_RETRIES` (整数, 例如默认 12)
    -   [x] `API_RETRY_BASE_DELAY_SECONDS` (浮点数, 例如默认 3.0)
    -   [x] `API_RETRY_MAX_DELAY_SECONDS` (浮点数, 例如默认 60.0) (用于限制单次指数退避的最大延迟)
    -   [x] `API_TOTAL_TIMEOUT_PER_CALL_SECONDS` (整数, 例如默认 100) (单次API调用含所有重试的总时长上限)
    -   [x] 确保 `spotify_config.json.example` 文件和相关文档（如 `project_workflow.md` 或 `README.md`）清晰地解释这些参数及其默认值和影响。
    -   [x] `ConfigManager` 需要能正确加载和提供这些新的配置值。

### 7.5 强化测试

-   [x] **7.5.1: 针对API重试机制的专项单元测试:**
    -   [x] Mock Spotify API的响应，精确模拟各种需要重试的错误场景（429, 500, 502, 503, 网络超时等）。
    -   [x] 验证在不同错误序列下，重试次数、延迟计算（包括指数退避和抖动）、最大延迟上限和总超时是否符合预期。
    -   [x] 验证日志记录是否准确反映了重试过程。
    -   [x] 测试在达到最大重试次数或总超时后，API调用是否正确报告为最终失败。
-   [x] **7.5.2: 端到端集成测试下的表现评估:**
    -   [x] （如果可行）在可控环境中模拟API间歇性故障，观察整体流程是否能通过重试恢复。
    -   [x] 验证当某个歌曲的API查询在所有重试后仍失败时，报告是否准确反映为"API调用失败"，并且不影响其他歌曲的处理。
    -   [x] 确认当API调用（可能在重试后）成功返回候选时，即使候选质量差，匹配器也能选出一个，并在报告中以低置信度标记。
    -   [x] 评估启用这种强力重试策略后，对处理包含少量"问题API调用"的歌曲列表时的总处理时间影响。

## VIII. 进一步优化搜索与匹配逻辑 (Stage 8)

**核心目标**: 在现有成熟工作流程的基础上，通过采用单一高效的自由文本曲目名搜索策略，结合强化的多维度匹配评分系统，并重点优化对Spotify API返回结果中中文内容变体的处理，以提升匹配精准度和对中文歌曲的处理能力。

### 8.1 搜索策略调整 (`spotify/async_client.py` 或调用处)
-   [ ] **8.1.1: 切换到单一自由文本曲目名搜索:**
    -   [ ] 修改API查询构建逻辑，主要使用用户输入的原始歌曲标题（或初步清理后的标题）进行自由文本搜索。
    -   [ ] 移除或注释掉现有的多阶段降级搜索逻辑，除非评估后认为有必要保留可选的、基于艺术家提示的补充自由文本搜索作为极低置信度下的最终手段。

### 8.2 智能匹配评分与选择逻辑增强 (`utils/enhanced_matcher.py` 或新模块)
-   [x] **8.2.1: 重构或扩展 `select_best_match` (或等效) 函数:**
          -   [x] **核心评分因素实现**:
          -   [x] **标题相似度**: 实现基于 `fuzzywuzzy.fuzz.token_set_ratio` 或 `partial_ratio` 的标题相似度计算，并在计算前对输入和候选标题进行标准化和简体中文统一化。
          -   [x] **艺术家相似度**: 实现艺术家列表间的相似度计算。对每个输入艺术家，在候选艺术家列表中找最佳匹配。重点处理Spotify返回的中文名（简繁统一）和可能的拼音形式（与输入艺术家名的拼音形式对比）。
          -   [x] **括号内容相似度**: 复用或增强现有 `BracketMatcher` 逻辑，比较括号内容，并对关键词和 `feat.` 艺术家进行处理（艺术家名处理同上）。
      -   [x] **综合评分与选择**:
          -   [x] 实现基于上述三个核心因素的加权综合评分机制。
          -   [x] 确保权重 (`W_title`, `W_artist`, `W_bracket`) 可通过配置文件调整。
          -   [x] 应用 `MATCH_THRESHOLD` 和 `LOW_CONFIDENCE_THRESHOLD` 判断最终匹配状态。

### 8.3 中文内容处理优化 (集成到匹配评分逻辑中)
-   [x] **8.3.1: 文本预处理统一化:**
    -   [x] 确保在所有相似度计算前，对输入文本和从Spotify获取的候选文本都执行统一预处理：转小写、全角转半角、移除干扰标点、**统一到简体中文 (使用 `opencc-python-reimplemented`)**。
-   [x] **8.3.2: 艺术家名称匹配鲁棒性提升:**
    -   [x] **拼音处理集成**: 在艺术家相似度计算中，当直接中文名比较效果不佳时，尝试将输入的中文艺术家名转为拼音 (使用 `pypinyin`)
### 8.4 配置与日志调整
-   [x] **8.4.1: 配置文件更新 (`spotify_config.json`):**
    -   [x] 审阅并调整匹配评分权重 (`W_title`, `W_artist`, `W_bracket`) 和相关阈值的默认值。
    -   [x] 确保新增或修改的配置项在 `spotify_config.json.example` 中有清晰说明。
-   [x] **8.4.2: 日志记录增强:**
    -   [x] 记录采用的自由文本查询语句。
    -   [x] 详细记录每个主要候选歌曲的标题、艺术家、括号各项相似度得分及最终综合得分。
    -   [x] 在日志中高亮或明确指出中文简繁转换和拼音匹配步骤的执行情况。

### 8.5 测试与验证
-   [x] **8.5.1: 扩展测试用例:**
    -   [x] 针对新的匹配逻辑和中文处理机制，设计更多包含复杂中文歌名、艺术家名（含多音字、简繁、拼音变体）的测试用例。
-   [x] **8.5.2: 性能和准确率评估:**
    -   [x] 在标准测试集上评估新方案的匹配准确率和处理性能，与旧方案进行对比。
    -   [x] 重点分析先前匹配失败或匹配错误的中文歌曲案例，验证改进效果。 

    ## IX. 优化搜索策略以提高匹配召回率 (Stage 9)

**核心目标**: 实施一个多阶段的搜索策略，优先使用最精确的信息组合（歌名+艺术家），并在必要时逐步回退到更宽松的搜索条件，以最大限度地确保从Spotify API获取候选歌曲。对于通过仅艺术家名搜索到的歌曲，将其标记为低置信度。

### 9.1 搜索逻辑调整 (`spotify/sync_client.py` 中的 `_search_with_sync_client` 或等效函数)
-   [ ] **9.1.1: 实现多阶段搜索查询逻辑:**
    -   [ ] **阶段一 (主要搜索 - 歌名 + 前两位艺术家):**
        -   [ ] 从 `parsed_song_info` 获取标准化后的歌曲标题和艺术家列表。
        -   [ ] 如果艺术家列表不为空，提取前两位艺术家（如果只有一位则取一位）。
        -   [ ] 构建查询: `track:{标准化歌名} artist:{第一位艺术家} artist:{第二位艺术家}` (或仅一位艺术家)。
        -   [ ] 执行Spotify API搜索。如果返回结果，则使用这些结果进行后续匹配，并跳过后续搜索阶段。
    -   [ ] **阶段二 (第一次备用搜索 - 仅歌名):**
        -   [ ] 如果阶段一未返回结果（或最初就没有艺术家信息），构建查询: `track:{标准化歌名}`。
        -   [ ] 执行Spotify API搜索。如果返回结果，则使用这些结果进行后续匹配，并跳过后续搜索阶段。
    -   [ ] **阶段三 (第二次备用搜索 - 仅前两位艺术家):**
        -   [ ] 如果阶段二仍未返回结果（且最初有艺术家信息），构建查询: `artist:{第一位艺术家} artist:{第二位艺术家}` (或仅一位艺术家)。
        -   [ ] 执行Spotify API搜索。
-   [ ] **9.1.2: 处理艺术家搜索结果的特殊标记:**
    -   [ ] 如果搜索最终通过阶段三（仅艺术家名）获得了候选歌曲：
        -   [ ] 在传递给匹配器之前或在匹配器内部，将这些候选歌曲的潜在匹配分数强制设置为0。
        -   [ ] 确保匹配结果（如 `MatchedSong` 对象）被明确标记为低置信度 (例如，设置 `is_low_confidence = True` 并记录 `matched_score = 0.0`)，无论后续的字符串相似度匹配结果如何。
-   [ ] **9.1.3: 整合和返回搜索结果:**
    -   [ ] 无论哪个阶段成功获取了候选歌曲，都将这些结果返回给调用者（例如 `search_song_on_spotify_sync_wrapped`）。
    -   [ ] 如果所有阶段都未能获取结果，则返回空列表或适当的无结果指示。

### 9.2 日志记录增强
-   [ ] **9.2.1: 记录采用的搜索阶段和查询:**
    -   [ ] 在日志中明确指出当前歌曲是使用了哪个搜索阶段（歌名+艺术家, 仅歌名, 仅艺术家）以及具体的查询字符串。
-   [ ] **9.2.2: 记录艺术家搜索的特殊处理:**
    -   [ ] 如果匹配结果来源于仅艺术家名的搜索，在日志中高亮或明确指出其匹配分数被置为0且标记为低置信度。

### 9.3 配置参数 (可选，如果需要调整行为)
-   [ ] **9.3.1: 审阅是否需要为新策略添加配置:**
    -   [ ] 例如，是否允许禁用某个搜索阶段，或调整艺术家数量。目前看，按固定逻辑即可。

### 9.4 测试与验证
-   [ ] **9.4.1: 针对新搜索策略设计测试用例:**
    -   [ ] 包含仅能通过歌名匹配的歌曲。
    -   [ ] 包含仅能通过艺术家名匹配的歌曲。
    -   [ ] 包含能通过歌名+艺术家名精确匹配的歌曲。
    -   [ ] 包含即使通过所有阶段也无法找到任何候选的歌曲。
-   [ ] **9.4.2: 验证低置信度标记:**
    -   [ ] 确保通过仅艺术家名搜索匹配到的歌曲，在报告中正确显示为低置信度且分数为0。
-   [ ] **9.4.3: 回归测试:**
    -   [ ] 确保新的搜索策略没有对先前能够正确匹配的歌曲产生负面影响。

## X. 优化匹配器评分逻辑以提高准确性 (Stage 10)

**核心目标**: 改进 `EnhancedMatcher` (或 `BracketAwareMatcher`) 内部的评分逻辑，以更准确地处理因文本归一化（如简繁体差异）和括号内特殊标记（如 `(Live)`, `(Remix)`）导致的不完全匹配，从而提升整体匹配准确率，减少误判为0分或低分的情况。

**背景**: 当前匹配逻辑可能因对文本差异过于敏感，导致实际上匹配度很高的歌曲（例如仅简繁体不同，或一方多出 `(Live)` 标签）被评为0分或不合理低分。

### 10.1 文本归一化增强 (`utils/text_normalizer.py`)
-   [ ] **10.1.1: 确保 `normalize_text` 函数包含全面的归一化步骤:**
    -   [ ] **强制简体中文转换**: 确保所有参与比较的文本（输入、候选标题、艺术家、括号内容）统一转换为简体中文。使用 `opencc-python-reimplemented`。
    -   [ ] **大小写统一**: 转换为小写。
    -   [ ] **全角/半角统一**: 统一为半角。
    -   [ ] **移除或替换特定不影响语义的标点符号**: 定义一个可配置的标点符号处理规则。
    -   [ ] **处理多余空格**: 清理首尾空格，压缩连续空格。
-   [ ] **10.1.2: 审阅并确保归一化函数在匹配流程的关键节点被调用:**
    -   [ ] 在 `EnhancedMatcher` 或其依赖组件（`StringMatcher`, `BracketMatcher`）中，所有从输入和候选歌曲中提取的待比较文本片段，在送入相似度算法前，必须先调用此增强的归一化函数。

### 10.2 相似度算法与评分逻辑优化 (`utils/enhanced_matcher.py`, `utils/string_matcher.py`, `utils/bracket_matcher.py`)
-   [x] **10.2.1: 标题与艺术家名称相似度计算优化:**
    -   [x] **采用 `fuzzywuzzy.fuzz.token_set_ratio`**: 对于标题和艺术家列表的相似度计算，优先使用或确保使用的是 `token_set_ratio`。此算法对词序不敏感，且能更好地处理部分词语重叠及额外词语的情况。
    -   [x] **组件路径**: 主要关注 `EnhancedMatcher` (或 `BracketAwareMatcher`) 内的 `_calculate_main_title_similarity`, `_calculate_artists_similarity` (或 `StringMatcher` 内的等效方法)。
-   [x] **10.2.2: `BracketMatcher` 逻辑优化 (`utils/bracket_matcher.py`):**
    -   [x] **提取与归一化**: 确保从输入和候选标题中提取的括号内容，在比较前也经过10.1中定义的全面归一化处理。
    -   [x] **相似度计算**: 对比归一化后的括号内容时，可使用 `token_set_ratio` 或针对短语特点的其他模糊匹配方法。
    -   [x] **智能评分调整策略**: 
        -   **完全匹配/高度相似的括号内容**: 如双方都有 `(live)` 或 `(remix)`，则应给予显著加分（通过 `keyword_bonus` 或基于相似度得分调整）。
        -   **一方有括号内容，另一方没有** (例如，输入为 "歌名 (Live)"，候选为 "歌名"):
            -   **主要策略**: **不应直接判为0分或大幅扣分**。可以考虑不加分，或仅轻微调整分数（加分或减分，幅度可配置）。目标是识别出核心歌名匹配，并将括号内容视为一个次要区分特征。
            -   如果缺失的括号内容是重要区分性信息（如不同版本的 `remix` vs `acoustic`），则差异性应体现在最终得分上，但不至于直接导致0分（除非核心歌名也完全不匹配）。
        -   **双方都有括号内容但不匹配** (例如 "歌名 (Live)" vs "歌名 (Radio Edit)"):
            -   这种情况应根据括号内容的语义差异和相似度来调整分数，差异越大，负向调整或正向加分越少。
    -   [x] **feat. 艺术家处理**: 在比较括号内容时，特别关注 `(feat. ArtistX)` 这类信息。如果一方有而另一方没有，或 `feat.` 的艺术家不同，这通常是较强的差异信号，评分调整应能反映这一点。
-   [x] **10.2.3: 综合评分权重与阈值审阅:**
    -   [x] 在上述归一化和相似度算法调整后，重新评估 `EnhancedMatcher` 中的权重配置 (`TITLE_WEIGHT`, `ARTIST_WEIGHT`, `BRACKET_WEIGHT`, `KEYWORD_BONUS`) 和阈值 (`MATCH_THRESHOLD`, `LOW_CONFIDENCE_THRESHOLD`, `FIRST_STAGE_THRESHOLD`, `SECOND_STAGE_THRESHOLD`)。
    -   [x] 目标是让真正的匹配（即使有简繁、括号标签差异）能够获得合理的高分，而明显错误的匹配得分较低。

### 10.3 日志与调试增强
-   [x] **10.3.1: 详细记录归一化与评分过程:**
    -   [x] 在匹配相关的类的DEBUG日志中，清晰记录以下信息：
        -   原始输入文本片段。
        -   归一化后的文本片段。
        -   各部分（标题、艺术家、括号）计算出的具体相似度得分。
        -   评分调整的步骤和原因（例如，因括号内容匹配/不匹配而进行的加分/减分）。
        -   最终的综合得分。
    -   [x] 这有助于调试评分逻辑，并理解为何某些匹配得到特定分数。

### 10.4 测试与验证
-   [x] **10.4.1: 扩展测试用例集:**
    -   [x] 补充更多针对简繁体差异、不同括号内容（`Live`, `Remix`, `Acoustic`, `feat.` 等）、有无括号内容等情况的测试用例。
    -   [x] 包含正例（应高分匹配）和反例（应低分或不匹配）。
-   [x] **10.4.2: 回归测试与性能评估:**
    -   [x] 确保新的评分逻辑没有对原先能够正确高分匹配的简单案例产生负面影响。
    -   [x] 评估修改对整体匹配性能（准确率、召回率、处理时间）的影响。

## XI. 匹配评分逻辑优化 (Stage 11 - 聚焦评分阶段)

**核心前提**: API搜索返回候选数据的三个阶段逻辑（歌名+艺术家，仅歌名，仅艺术家）**保持不变**。所有优化都发生在获取到这些候选歌曲信息之后，在进行匹配评分的环节。

### 11.1 评分前置：统一文本标准化
-   [x] **11.1.1: 标准化输入歌曲信息:**
    -   [x] 在 `EnhancedMatcher` 内部，对用户输入的原始歌曲标题和艺术家列表，使用 `TextNormalizer` 进行一次全面的标准化（强制简体、大小写、全半角、标点、空格、括号格式）。
-   [x] **11.1.2: 标准化候选歌曲信息:**
    -   [x] 对从API返回的每一首候选歌曲，将其标题、艺术家列表也通过同一个 `TextNormalizer` 实例进行标准化。
-   [x] **11.1.3: 确保标准化覆盖所有比较文本:**
    -   [x] 验证括号内的文本在提取后也经过了同样的标准化流程。

### 11.2 标题相似度计算优化
-   [x ] **11.2.1: 使用标准化文本进行比较:**
    -   [x ] 确保标题相似度计算逻辑（如 `_calculate_title_similarity`）直接使用11.1中标准化的输入标题和候选标题。
    -   [ x] 核心相似度算法（如 `fuzzywuzzy.fuzz.token_set_ratio`）及权重保持不变。

### 11.3 艺术家相似度计算优化 (考虑拼音)
-   [x ] **11.3.1: 使用标准化艺术家列表:**
    -   [ x] 确保艺术家相似度计算逻辑（如 `_calculate_artists_similarity`）使用11.1中标准化的艺术家列表。
-   [x ] **11.3.2: 实现主要艺术家匹配保障:**
    -   [ x] 如果标准化后的输入主要艺术家完全存在于标准化后的候选艺术家列表中，则设定一个较高的基础艺术家得分（例如，保证至少80-85分）。
-   [x ] **11.3.3: 实现补充拼音比较逻辑:**
    -   [ x] 若初步基于文本的艺术家相似度较低（如低于60分）：
        -   [ x] 尝试将标准化的中文艺术家名转换为标准拼音。
        -   [ x] 尝试将候选的艺术家名（若为中文则转拼音，若像拼音则直接使用）与输入的拼音进行比较。
        -   [ x] 若拼音比较高度相似，则显著提升该候选的艺术家得分。
    -   [ x] 核心相似度算法及权重保持不变。

### 11.4 括号内内容匹配优化
- [x] **11.4.1: 使用标准化括号内容:**
    - [x] 确保从标准化标题中提取的括号内容，在比较前再次确认其自身的标准化。
- [x] **11.4.2: 优化常见别名指示词处理:**
    - [x] 对于如"(又名：...)"、"(aka...)"等模式，标准化处理后提取核心内容进行比较。
    - [x] 核心相似度算法及权重保持不变。

### 11.5 最终匹配分数计算与低分处理优化
-   [ ] **11.5.1: 维持现有加权综合评分方式:**
    -   [ ] 继续使用现有的 `TITLE_WEIGHT`, `ARTIST_WEIGHT`, `BRACKET_WEIGHT` 组合各部分得分。
-   [ ] **11.5.2: 优化 `is_artist_only_search` 时的分数处理:**
    -   [ ] 即使是仅艺术家搜索的候选，也应采用 `EnhancedMatcher` 计算的实际内容匹配分数。
    -   [ ] `is_low_confidence` 标志可保留，但不应强制将高实际匹配分覆盖为固定低分（如50分）。
-   [ ] **11.5.3: 优化 `final_score <= 5.0` (或极低分) 时的回退逻辑:**
    -   [ ] 如果某单项（如标准化后标题完全匹配，得100分）得分很高，即使总分因其他项过低而极低，最终分数也不应是固定的50分。
    -   [ ] 考虑动态下限，例如：如果标准化标题100%匹配，则最终分数不应低于一个特定值（例如70分），除非艺术家完全不相关。或者 `max(一个基础值, 0.6 * 最高单项分)`。
    -   [ ] 目标是减少不合理的硬编码低分，使分数更真实反映部分高质量匹配。

### 11.6 测试与验证
-   [ ] **11.6.1: 针对性设计测试用例:**
    -   [ ] 包含简繁体差异、拼音艺术家名、额外艺术家、不同括号格式等场景。
    -   [ ] 验证先前报告的低分问题（如"三十岁的女人 - 赵雷"，"给你呀 - 蒋小呢"）是否得到改善。
-   [ ] **11.6.2: 回归测试:**
    -   [ ] 确保优化没有对原先能够正确高分匹配的简单案例产生负面影响。
-   [ ] **11.6.3: 性能评估:**
    -   [ ] 确认上述调整未显著降低匹配流程的整体性能。